name: Regresi칩n Visual TN - Paralela

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'N칰mero de versi칩n a testear (ej: 170)'
        required: true
        default: '1'
        type: string

jobs:
  # ==========================================================
  # 1. EJECUCI칍N PARALELA (5 jobs de 4 URLs cada uno)
  # ==========================================================
  run_tests_parallel:
    name: Test Group ${{ matrix.group }}
    runs-on: ubuntu-latest
    
    strategy:
      # Si un grupo falla, los dem치s contin칰an hasta el final.
      fail-fast: false 
      matrix:
        # Esto genera 5 trabajos paralelos, uno por cada grupo de URLs.
        # (18 URLs: 4, 4, 4, 4, 2)
        group: [1, 2, 3, 4, 5] 
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Instalar dependencias
      # Aseg칰rate de que 'requirements.txt' contenga: selenium, webdriver-manager, opencv-python, Pillow, json
      run: |
        pip install -r requirements.txt

    - name: 游 Ejecutar script para el GRUPO ${{ matrix.group }}
      # Pasamos el tag de versi칩n y el n칰mero de grupo como argumentos
      # La salida de los archivos se genera en la carpeta 'Reportes HTML - TN - MOBILE - PROD'
      run: |
        python regre_visual_tn_webmobile_prod.py ${{ github.event.inputs.version_tag }} ${{ matrix.group }}
    
    - name: 游 Subir Artefactos (Resultados Parciales)
      uses: actions/upload-artifact@v4
      with:
        # Nombre del artefacto, incluyendo el grupo para identificarlos.
        # Esto crea carpetas con el nombre 'resultados-grupo-X' con el contenido dentro.
        name: resultados-grupo-${{ matrix.group }}
        path: |
          Reportes HTML - TN - MOBILE - PROD/data_G${{ matrix.group }}_*.json
          Reportes HTML - TN - MOBILE - PROD/*.png
          
  # ==========================================================
  # 2. CONSOLIDACI칍N DE RESULTADOS (Se ejecuta al final)
  # ==========================================================
  consolidate_results:
    name: 游닇 Consolidar Reporte Final
    runs-on: ubuntu-latest
    # **Clave:** Espera que todos los trabajos de la matriz (run_tests_parallel) terminen.
    needs: run_tests_parallel 
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Instalar dependencias
      run: |
        pip install -r requirements.txt
      
    - name: 拘勇 Descargar todos los resultados parciales
      uses: actions/download-artifact@v4
      with:
        # Descarga todos los artefactos de la matriz en la carpeta 'artifacts'
        path: artifacts 

    - name: Unificar datos y generar reporte final
      run: |
        # Ejecuta el script de consolidaci칩n con la versi칩n como argumento.
        python consolidate_report.py ${{ github.event.inputs.version_tag }} 
        
    - name: 拘勇 Subir Reporte HTML FINAL (칔nico)
      uses: actions/upload-artifact@v4
      with:
        name: Reporte-Final-v${{ github.event.inputs.version_tag }}
        # Subimos el HTML final que se gener칩 DENTRO de la carpeta 'artifacts'
        path: artifacts/Reporte_FINAL_v${{ github.event.inputs.version_tag }}_*.html
